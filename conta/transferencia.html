<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transferência</title><link rel="stylesheet" href="../style.css"></head>
<body>
  <div class="header">💸 Transferência</div>
  <div class="container card">
    <p><b>Cliente já cadastrado?</b></p>
    <div class="flex">
      <button type="button" class="primary" onclick="mostrarSelecionar()">✅ Sim</button>
      <a class="btn" href="../clientes/abrir_conta.html">➕ Não (Cadastrar)</a>
    </div>
    <div id="seletor" style="display:none;">
      <label>Selecionar Cliente</label>
      <select id="clienteSel"></select>
      <p class="small" id="dadosCliente"></p>
    </div>
    <hr>
    <form id="formTransf">
      <label>Agência Destino</label><input name="agencia" required>
      <label>Conta Destino</label><input name="conta" required>
      <label>Tipo</label><select name="tipo"><option>PIX</option><option>TED</option></select>
      <label>Valor (R$)</label><input name="valor" type="number" step="0.01" required>
      <button class="primary" type="submit">Avançar (Biometria)</button>
    </form>
    <p class="small">Após enviar, será solicitada a biometria do cliente selecionado.</p>
  </div>
<script>
function carregarClientes(){
  const clientes=JSON.parse(localStorage.getItem('clientes')||'[]');
  const sel=document.getElementById('clienteSel'); sel.innerHTML='';
  clientes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=`${c.nome} - CPF ${c.cpf}`; sel.appendChild(o); });
  if(clientes.length){ sel.value=clientes[0].id; renderInfo(); }
  else { document.getElementById('dadosCliente').innerText = 'Nenhum cliente cadastrado. Clique em "Não (Cadastrar)".'; }
}
function renderInfo(){
  const id=document.getElementById('clienteSel').value;
  const c=(JSON.parse(localStorage.getItem('clientes')||'[]')).find(x=>x.id===id);
  if(!c) return;
  document.getElementById('dadosCliente').innerText = `Agência: ${c.agencia} | Conta: ${c.conta} | Saldo: R$ ${(c.saldo||0).toLocaleString('pt-BR')}`;
  localStorage.setItem('last_cliente_id', id);
}
function mostrarSelecionar(){
  document.getElementById('seletor').style.display='block';
  carregarClientes();
  document.getElementById('clienteSel').addEventListener('change', renderInfo);
}
document.getElementById('formTransf').addEventListener('submit', function(e){
  e.preventDefault();
  const id=localStorage.getItem('last_cliente_id');
  if(!id){ alert('Selecione um cliente cadastrado.'); return; }
  const data=Object.fromEntries(new FormData(this).entries());
  data.valor=parseFloat(data.valor||'0');
  if(!(data.valor>0)){ alert('Informe um valor válido.'); return; }
  sessionStorage.setItem('transf_dados', JSON.stringify(data));
  sessionStorage.setItem('transf_cliente_id', id);
  location.href="../login/biometria.html?redirect=../conta/comprovante.html&fallback=../conta/erro.html";
});
</script>
</body>
</html>
